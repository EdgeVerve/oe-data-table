<!--
  Â©2016-2017 EdgeVerve Systems Limited (a fully owned Infosys subsidiary),
  Bangalore, India. All Rights Reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/editor-icons.html">
<link rel="import" href="../iron-icons/image-icons.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../polymer-sortablejs/polymer-sortablejs.html">
<link rel="import" href="../oe-i18n-msg/oe-i18n-msg.html">
<link rel="import" href="oe-data-table-cell.html">
<link rel="import" href="oe-data-table-behavior.html">
<link rel="import" href="oe-data-table-header-cell.html">
<link rel="import" href="oe-data-table-column-chooser.html">
<link rel="import" href="oe-data-table-column-customizer.html">

<link rel="import" href="../oe-ui-forms/lazy-component.html">
<!--
### oe-data-table

`<oe-data-table>` is a component for displaying data in tabular format. It is a Polymer component styled with Material Design Data Table Standards.
  It can be used to add, edit and delete data in a model which has a `embedded`/`hasMany` relation.
  Also to display the entries in a model

  The data to be shown is set to `items` and columns to show is set to `columns`.

### Defining Columns

The column(s) to show in the table can be configured using the `columns` property.
The `columns` property takes an array of objects which can have the following properties.

Column property | Description
----------------|-------------
`key` | The key of the row to get data from.
`label` | The string to be shown in column header.
`tooltip` | The string to be shown in column header as a tooltip.
`valueAsTooltip`| Boolean flag to show value of a column as a tooltip on hover. Useful when the values are large and are hidden due to column width
`type` | The type of the content that is shown in the column. For example date, timestamp, number, string.
`uitype` | (Deprecated. use type) The type of the content that is shown in the column. For example date, timestamp.
`uiType` | The input control that has to be used for inline editing.
`readOnly` | Boolean flag denoting whether the column is non editable in inline mode , by default it is false.
`width` | Width of the column in `px`.
`minWidth` | Min Width of the column in `px`, by default grid level min width will be taken.
`sort` |  Sort order of the current column. Takes either `asc` or `desc`.
`alignment` | Alignment of the cell content , can have `left`,`right` or `center` .
`firstToSort` | Whether to sort first by desc or asc, by default it is asc.
`formatter` | A custom formatting function which returns the value to show in the cell.
`renderer` | A custom rendering function which returns the element to show in the cell.
`href` | Takes an express styled path and shows the cell content as a `hyperlink` with the provided path. For example, href="/models/customer/:id".
`cellClass` | Class to apply on data table cell.
`cellClassRules` | Object having class name to be applied as key and an expression to evaluate as value.
`valueGetter` | A custom getter function which returns a value for the property specified in the `key`.
`hidden` | Column will be hidden if it is set to true.

### Styling

`<oe-data-table>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--oe-data-table` | Mixin to be applied to whole table | {}
`--oe-data-table-header` | Mixin to be applied to the table header  | {}
`--oe-data-table-header-title` | Mixin to be applied to the table header title  | {}
`--oe-data-table-row` | Mixin to be applied to the table row | {}
`--oe-data-table-row-selected` | Mixiin to be applied to the table row when selected | {}
`--oe-data-table-row-hover` | Mixin to be applied to the table row on hover | {}
`--oe-data-table-row-first` | Mixin to be applied to the first row of the table | {}
`--oe-data-table-row-last` | Mixin to be applied to the last row of the table | {}
`--oe-data-table-data` | Mixin to be applied to the table cell | {}
`--oe-data-table-column-first` | Mixin to be applied to the first column | {}
`--oe-data-table-column-last` | Mixin to be applied to the last column | {}
`--oe-data-table-selection-cell-content` | Mixiin to be applied to the selection cell content if provided | {}
`--oe-data-table-row-action` | Mixin applied to the row action icon buttons | {}

@demo demo/demo-oe-data-table.html

-->
<dom-module id="oe-data-table">

  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        width: 100%;
        display: block;
        font-family: Roboto;

        --row-width: initial;
      }

      paper-material {
        color: var(--primary-text-color);

        @apply(--oe-data-table);
      }

      .data-table {
        overflow-y: auto;
      }

      .grid-header {
        height: 64px;
        padding: 0 14px 0 24px;
        box-sizing: border-box;
        background: #FFFFFF;
        box-shadow: 1px 1px 2px 0 rgba(0,0,0,0.16);
        border-radius: 4px 4px 0 0;
        margin-bottom: 4px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-justified);
        @apply(--oe-data-table-header);
      }

      .icon-group {
        color: rgba(0, 0, 0, 0.54);
      }

      .header-title {
        font-size: 20px;
        color: rgba(0, 0, 0, 0.87);
        font-weight: 400;
        font-style: normal;

        @apply(--oe-data-table-header-title);
      }

      #table-header {
        font-size: 12px;
        height: 55px;
        color: rgba(0, 0, 0, 0.54);
        font-weight: 700;
        font-style: normal;
        overflow-x: hidden;
        border-bottom: 1px solid #ededed;
        background: #FFF;
        @apply(--oe-data-table-column-header);
        @apply(--layout);
      }

      .multi-select-true{
        background:var(--primary-light-color,#d1e9fd);
        border: 1px solid #b9cfe2;
      }
      .multi-select-true .header-title{
        margin:0px 16px;
      }

      .selected-items-count{
        font-size: 14px;
        color: rgba(0,0,0,0.87)
      }
      .grid-info > iron-icon{
        cursor: pointer;
        --iron-icon-width:16px;
        --iron-icon-height:16px;
      }
      .grid-info{
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .header-icon {
        display: inline-block;
      }

      paper-progress {
        position: absolute;
        width: 100%;
      }

      .table-body {
        font-size: 13px;
        color: rgba(0, 0, 0, 0.87);
        font-weight: 400;
        font-style: normal;

        @apply(--layout-vertical);
      }

      .table-body.reverse {
        @apply(--layout-vertical-reverse);
      }

      iron-list {
        height: 100%;

        --iron-list-items-container: {
          width: var(--row-width);
        }
      }

      .selection-cell {
        position: relative;

        @apply(--layout);
        @apply(--layout-center);
      }

      .selection-checkbox {
        padding: 0 24px;
      }

      paper-checkbox.selection-checkbox {
        --paper-checkbox-label-spacing: 0;
        --paper-checkbox-checked-color: var(--secondary-color);
      }

      .selection-cell-content {
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        width: 32px;
        height: 32px;
        margin: auto;
        color: #fff;
        margin-left: 16px;
        border-radius: 50%;
        position: absolute;
        background-size: cover;
        background-position: center center;

        @apply(--layout);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        @apply(--oe-data-table-selection-cell-content);
      }

      .selection-cell:hover .selection-cell-content,
      .table-row.selected .selection-cell-content {
        display: none;
      }

      .table-row {
        min-height: 48px;
        border-bottom: 1px solid #ededed;
        background: #FFF;
        @apply(--layout);
        @apply(--oe-data-table-row);
      }

      .table-row.selected {
        background: #f5f5f5;

        @apply(--oe-data-table-row-selected);
      }

      .table-row:hover {
        background: #eee;

        @apply(--oe-data-table-row-hover);
      }

      .table-row:first-of-type {
        @apply(--oe-data-table-row-first);
      }

      .table-row:last-of-type {
        @apply(--oe-data-table-row-last);
      }

      .table-data {
        min-height: 47px;
        padding-right: 56px;
        overflow: hidden;
        box-sizing: border-box;

        @apply(--layout-center);
        @apply(--layout-inline);
        @apply(--layout-flex);
        @apply(--oe-data-table-data);
      }

      .table-data-others {
        padding: 0;

        @apply(--layout-vertical);
        @apply(--layout-center-justified);
      }

      .table-data:first-of-type {
        padding: 0;
        padding-right: 24px;
      }

      :host[disable-selection] .table-data:first-of-type {
        padding-left: 24px;
      }

      .table-data:last-of-type {
        padding-right: 24px;
      }

      .table-data:first-of-type {
        @apply(--oe-data-table-column-first);
      }

      .table-data:last-of-type {
        @apply(--oe-data-table-column-last);
      }

      .row-actions {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .row-action {
        display: none;

        @apply(--oe-data-table-row-action);
      }

      .table-row:hover .row-action {
        display: inline-block;
      }

      .pagination-panel {
        width: 100%;
        height: 56px;
        font-size: 12px;
        font-family: Roboto;
        font-weight: 600;
        padding: 0 14px;
        box-sizing: border-box;
        color: rgba(0, 0, 0, 0.54);
        -webkit-user-select: none;
        border-top: 1px solid #ededed;

        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-end-justified);
      }

      .row-details {
        padding: 0 32px;
      }

      .pagination-dropdown-title {
        margin-left: 32px;
      }

      paper-dropdown-menu {
        padding: 0 10px;
        padding-top: 2px;

        --paper-dropdown-menu-input: {
          width: 50px;
        }
        --paper-input-container-underline: {
          display: none;
        }
        --paper-input-container-input: {
          font-size: 12px;
          text-align: center;
        }
      }

      .form-content {
        height: 100%;
      }

      .summary-row {
        background: #f5f5f5;
      }

      #summary-row-content {
        overflow-x: hidden;

        @apply(--layout);
      }

      .summary-cell {
        height: 56px;
        font-family: Roboto;
        font-size: 13px;
        font-weight: 500;
        color: rgba(0, 0, 0, 0.87);
      }

      .selection-cell.summary-cell {
        min-width: 66px;
      }

      .summary-cell-content {
        width: 100%;
      }

      .empty-state{
        height: 100%;
      }
    </style>

    <paper-material class="data-table">
      <iron-collapse opened="{{showGrid(_hideGrid,_customizeView)}}">
        <template is="dom-if" if="[[!hideHeader]]">
          <div id="grid-header" class$="multi-select-[[_isMultiSelected(selectedItems.length)]] grid-header">
            <div class="grid-info">
              <iron-icon icon="arrow-back" on-tap="_toggleSelectAll" hidden=[[!_isMultiSelected(selectedItems.length)]]></iron-icon>
              <div class="header-title">
                [[label]]
                <content select="[header-title]"></content>
              </div>
              <div class="selected-items-count" hidden=[[!_isMultiSelected(selectedItems.length)]]>
                [[selectedItems.length]] items selected
              </div>
            </div>
            <div class="icon-group">
              <template is="dom-if" if="[[!disabled]]">
                <template is="dom-if" if="[[dataController]]">
                  <paper-icon-button id="refresh-icon" icon="icons:refresh" on-tap="render"></paper-icon-button>
                  <paper-tooltip for="refresh-icon"> Refresh </paper-tooltip>
                </template>
                <template is="dom-if" if="[[!selectedItems.length]]">
                  <template is="dom-if" if="[[!disableAdd]]">
                    <div class="header-icon">
                      <paper-icon-button icon="icons:add-circle-outline" on-tap="_showAddForm"></paper-icon-button>
                      <paper-tooltip> New </paper-tooltip>
                    </div>
                  </template>
                  <template is="dom-if" if="[[!disableConfigEditor]]">
                    <div class="header-icon">
                      <paper-icon-button icon="image:tune" on-tap="_openColumnCustomizer"></paper-icon-button>
                      <paper-tooltip> Customize View </paper-tooltip>
                    </div>
                  </template>
                </template>
                <template is="dom-if" if="[[selectedItems.length]]">
                  <template is="dom-if" if="[[!disableEdit]]">
                  <div class="header-icon" hidden$=[[_hideEditIcon(selectedItems.length)]]>
                    <paper-icon-button icon="editor:mode-edit" on-tap="_showEditForm"></paper-icon-button>
                    <paper-tooltip> Edit </paper-tooltip>
                  </div>
                  </template>
                  <template is="dom-if" if="[[!disableDelete]]">
                  <div class="header-icon">
                    <paper-icon-button id="delete-icon" icon="delete" on-tap="_deleteSelectedRows"></paper-icon-button>
                    <paper-tooltip> Delete </paper-tooltip>
                  </div>
                  </template>
                </template>
                <template is="dom-repeat" items=[[toolbarActions]] as="action">
                  <div class="header-icon">
                    <paper-icon-button icon="[[action.icon]]" on-tap="_tableActionTapped"></paper-icon-button>
                    <paper-tooltip>
                      <oe-i18n-msg msgid=[[action.title]]>[[action.title]]</oe-i18n-msg>
                    </paper-tooltip>
                  </div>
                </template>
                <template is="dom-if" if="{{_showMenuIcon(configCode,menuActions)}}">
                  <paper-menu-button horizontal-align="right">
                    <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
                    <paper-menu class="dropdown-content">
                      <!--<paper-item on-tap="_openColumnChooser"> Choose Columns</paper-item>-->
                      <template is="dom-repeat" items=[[menuActions]] as="action">
                        <paper-icon-item on-tap="_tableActionTapped">
                          <iron-icon icon="[[action.icon]]" item-icon></iron-icon>
                          <oe-i18n-msg msgid=[[action.title]]>[[action.title]]</oe-i18n-msg>
                        </paper-icon-item>
                      </template>
                      <template is="dom-if" if=[[configCode]]>
                        <paper-icon-item on-tap="_saveGridConfig">
                          <iron-icon icon="save" item-icon></iron-icon>
                          <oe-i18n-msg msgid="Save Grid Config">Save Grid Config</oe-i18n-msg>
                        </paper-icon-item>
                      </template>
                    </paper-menu>
                  </paper-menu-button>
                </template>
              </template>
            </div>
          </div>
        </template>
        <div id="table-header" style$="margin-right: [[_scrollBarWidth]]px;">
          <template is="dom-if" if="[[!disableSelection]]">
            <div class="selection-cell">
              <paper-checkbox class="selection-checkbox" checked=[[_selectedAll]] disabled$=[[!multiSelection]] on-change="_toggleSelectAll"></paper-checkbox>
            </div>
          </template>
          <template is="dom-repeat" items="{{columns}}" as="column" filter="_getVisibleColumns" observe="hidden">
            <oe-data-table-header-cell col-index=[[index]] class="table-data" items=[[items]] column={{column}} is-server-data=[[isServerData]] has-pagination=[[_hasPagination]]
              style$="flex: [[_computeCellWidth(column.width)]]; min-width: [[_computeCellMinWidth(column.minWidth)]]"></oe-data-table-header-cell>
          </template>
          <template is="dom-if" if=[[rowActions.length]]>
            <div class="table-data" style$="flex: [[_computeRowActionWidth(rowActions.length)]]"></div>
          </template>
        </div>
        <div class$="table-body [[_computeTableBodyClass(aggregatorAlignTop)]]">
          <template is="dom-if" if={{_loadingData}}>
            <paper-progress indeterminate></paper-progress>
          </template>
          <div style$="height: [[_computeGridHeight(pageSize,_items.length)]]px">
            <template is="dom-if" if=[[_items.length]] restamp=true>
              <iron-list index-as="rowIndex" id="row-list" items="{{_items}}" as="row" max-physical-count="[[_maxDomElement]]" on-scroll="_scrollHandler" on-iron-resize="_updateRowWidth" index-as="key">
                <template>
                  <div class$="table-row [[_computeClassforRow(row,_computeSelection)]]" tabindex$="[[tabIndex]]" on-tap="_rowClicked">
                    <template is="dom-if" if="[[!disableSelection]]">
                      <div class="selection-cell">
                        <paper-checkbox class="selection-checkbox" on-change="_toggleSelection" on-keydown="_goToCell" on-tap="_checkboxTapped" checked={{_getSelectionState(row,_computeSelection)}}></paper-checkbox>
                        <template is="dom-if" if="[[selectionCellContent]]">
                          <div class="selection-cell-content" style$="[[_computeSelectionCellContentStyle(row,selectionCellContent)]];">
                            <template is="dom-if" if="[[_enableSelectionCellContent(row, selectionCellContent)]]">
                              <div> [[_getFirstLetter(row,selectionCellContent.content)]] </div>
                            </template>
                          </div>
                        </template>
                      </div>
                    </template>
                    <template is="dom-repeat" items="[[columns]]" as="column" filter="_getVisibleColumns" observe="hidden">
                      <oe-data-table-cell is-first-row=[[_isFirstRow(rowIndex,row)]] read-only=[[_computeReadOnly(disableEdit,disabled)]] key=[[key]] row={{row}} column=[[column]] class$="table-data [[_computeCellClass(row.*,column)]]" column-template=[[_getValidTemplate(row.*,row,column)]] style$="flex: [[_computeCellWidth(column.width)]]; min-width: [[_computeCellMinWidth(column.minWidth)]]"></oe-data-table-cell>
                    </template>
                    <template is="dom-if" if=[[rowActions.length]]>
                      <div class="row-actions" style$="flex: [[_computeRowActionWidth(rowActions.length)]]">
                        <template is="dom-repeat" items=[[rowActions]] as="action">
                          <div>
                            <paper-icon-button class="row-action" row$=[[row]] icon="[[action.icon]]" on-tap="_rowActionClicked"></paper-icon-button>
                            <paper-tooltip position="left"> [[action.title]] </paper-tooltip>
                          </div>
                        </template>
                      </div>
                    </template>
                  </div>
                </template>
              </iron-list>
            </template>
            <template is="dom-if" if=[[!_items.length]] restamp=true>
              <div class="empty-state layout horizontal center-center">
                <label>[[emptyStateMessage]]</label>
              </div>
            </template>
          </div>
          <template is="dom-if" if="[[_hasAggregator(columns.*)]]">
            <div class="summary-row">
              <div id="summary-row-content" style$="margin-right: [[_scrollBarWidth]]px;">
                <template is="dom-if" if="[[!disableSelection]]">
                  <div class="selection-cell summary-cell"> </div>
                </template>
                <template is="dom-repeat" items="{{columns}}" as="column">
                  <oe-data-table-summary-cell class="summary-cell table-data" style$="flex: [[_computeCellWidth(column.width)]]; min-width: [[_computeCellMinWidth(column.minWidth)]];">
                    <div class="summary-cell-content" style$="[[_computeCellAlignment(column)]]"> [[_computeSummary(column,_items.*)]] </div>
                  </oe-data-table-summary-cell>
                </template>
              </div>
            </div>
          </template>
        </div>
        <template is="dom-if" if={{dataController}}>
          <div class="pagination-panel">
            <div class="pagination-dropdown-title"> Rows per page: </div>
            <paper-dropdown-menu no-label-float vertical-align="bottom" horizontal-align="left">
              <paper-listbox class="dropdown-content" attr-for-selected="value" selected={{pageSize}}>
                <template is="dom-repeat" items=[[rowsPerPageItems]]>
                  <paper-item value=[[item]]>[[item]]</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
            <div class="row-details">
              <span> [[_startRow]]-[[_endRow]] of [[_totalRowsCount(rowCount)]] </span>
            </div>
            <paper-icon-button disabled$="[[_disablePrevious(currentPage)]]" icon="image:navigate-before" on-tap="_previousPage"> </paper-icon-button>
            <paper-icon-button disabled$="[[_disableNext(_isLastPage)]]" icon="image:navigate-next" on-tap="_nextPage"> </paper-icon-button>
          </div>
        </template>
      </iron-collapse>
      <iron-collapse id="column-customizer" opened="{{_customizeView}}">
        <oe-data-table-column-customizer columns="{{columns}}" title="{{label}}" on-close-column-customizer="_hideColumnCustomizer"></oe-data-table-column-customizer>
      </iron-collapse>
      <iron-collapse opened="{{_hideGrid}}">
        <div class="form-content">
          <paper-icon-button icon="icons:arrow-back" on-tap="_goBack"></paper-icon-button>
          <lazy-component id="form-component" url={{dataTableFormUrl}} model={{modelToEdit}} emit-on-save={{emitOnSave}}></lazy-component>
        </div>
      </iron-collapse>
    </paper-material>
    <content></content>
    <oe-data-table-column-chooser id="column-chooser" columns={{columns}}></oe-data-table-column-chooser>
  </template>
</dom-module>
<script>
  var kebabCaseToCamelCase = function (str) {
    return str.replace(/-([a-z])/g, function (group) {
      return group[1].toUpperCase();
    });
  };

  Polymer({
    is: 'oe-data-table',
    properties: {

      /**
       * Setting to `true` hides the header
       */
      hideHeader: {
        type: Boolean,
        value: false
      },

      /**
      * Disable Add, Edit, Delete and Column-Config options
      */
      disabled: {
        type: Boolean,
        value: false
      },

      /**
      * Disable adding new records
      */
      disableAdd: {
        type: Boolean,
        value: false
      },
      /**
      * Disable editing records
      */
      disableEdit: {
        type: Boolean,
        value: false
      },
      /**
      * Disable deleting records
      */
      disableDelete: {
        type: Boolean,
        value: false
      },
      /**
      * Disable editing column  configuration.
      */
      disableConfigEditor: {
        type: Boolean,
        value: false
      },
      /**
      * Disable row selection
      */
      disableSelection: {
        type: Boolean,
        value: false
      },
      
      /**
       * Array of page numbers that has to be shown in Rows per page dropdown
       */
      rowsPerPageItems: {
        type: Array,
        value: [5, 10, 15, 25, 50, 100, 200, 500, 1000]
      },

      /**
       * Minimum width that every column should accommodate. Can be overridden in column level.
       */
      minColWidth: {
        type: Number,
        value: 125
      },

      /**
       * The page to show when a row is added/edited. For example "/components/customer-default.html"
       */
      editorFormUrl: {
        type: String
      },

      emitOnSave: {
        type: String
      },
      
      emptyStateMessage:{
        type: String,
        value:"No records found"
      },
      _modelBeingUpdated: {
        type: Object
      },

      /**
       * When the grid is showing a list of models which needs to be saved by calling save api, then recordHandling needs to be `remote` which is default mode, if it is used for showing embedded/hasMany relations , then the recordHandling needs to be `local`/`localex` respectively.
       */
      recordHandling: {
        type: String,
        value: 'remote'
      },

      _activeCell: {
        type: Object,
        value: function () {
          return null;
        }
      },
      defaultRecord: {
        type: Object
      },
      toolbarActions: {
        type: Array
      },

      menuActions: {
        type: Array,
        value: function () {
          return [];
        }
      },

      /**
       *  setting `selectionCellContent` with an object will display an circular overlay with configured content above the selection checkbox.
       *  The overlay will be hidden when that cell is hovered. This object can have the following properties
       *  `content` - The property of the row object whose first character that has to be displayed
       *  `image` - The property of the row object which contains the URL of the image to be displayed
       *
       *  The object can be provided with either `content` or `image`. If both the properties are provided, image will take precedence.
       *  @type {{ content : string, image: string }}
       */
      selectionCellContent: {
        type: Object
      },

      /**
       *  A grid config object. Takes an object with columns and editorFormUrl. Setting this property sets the columns property and editorFormUrl property if provided
       *
       *  @type {{ columns : array, editorFormUrl: string }}
       */
      config: {
        type: Object,
        observer: '_configChanged'
      },

      configCode: {
        type: String,
        value: '',
        observer: '_configCodeChanged'
      },

      /*
       *  Setting to `true` shows the aggregator row between column header and table body.
       */
      aggregatorAlignTop: {
        type: Boolean
      },

      /**
       *  Array of action objects that to be shown in each row.
       */
      rowActions: {
        type: Array
      }

    },

    behaviors: [
      OEUtils.DataTableBehaviour,
      Polymer.Templatizer
    ],

    listeners: {
      'change-column-width': '_changeColumnWidth',
      'set-active-cell': '_setActiveCell',
      'customize-view': 'customizeView',
      'oe-cell-rendered':'_updateIronList'
    },

    observers: [
      '_updateRowWidth(_items.*)',
      '_keyHandlers(disabled,_items.length)'
    ],
    _keyHandlers:function(){
      if(this._items.length == 0){
        return;
      }
      this.async(function(){
        var ironList = this.querySelector('#row-list');
        if(this.disabled){
          this.listen(ironList, 'keydown', '_keyDownListener');
        }else{
          this.unlisten(ironList, 'keydown', '_keyDownListener');
        }
      })  
    },
    _keyDownListener:function(e){
      if(this.selectedItems.length !== 1){
        return;
      }
      if(e.keyCode === 40 || e.keyCode === 38){
        var selectedIndex = this._items.indexOf(this.selectedItems[0]);
        if(e.keyCode === 40){
          //down arrow
          if(selectedIndex+1 === this._items.length){
            return;
          }
          selectedIndex++;
        }else if(e.keyCode === 38){
          //up arrow
          if(selectedIndex === 0){
            return;
          }
          selectedIndex--;
        }
        this.toggleSelection(this._items[selectedIndex]);
      }
     
    },
    _isFirstRow:function(idx,row){
      return (idx === 0);
    },
    _updateIronList:function(e){
      if(e.detail > this.maxRowHeight){
        this.maxRowHeight = e.detail;
        this.debounce('rowHeight',this.updateRowHeight,300)
      }
    },
    updateRowHeight:function(){
      var rowList = this.$$('#row-list');
      if (rowList) {
        rowList.notifyResize();
      }
    },
    ready: function () {
      if (!this.ctor) {
        const childTemplates = this.queryAllEffectiveChildren('template[column-key]');
        if (childTemplates) {
            this.set('_columnTemplates',childTemplates);
        }
      }
      var children = this.children;
      if (children.length > 1 && children[1].tagName === 'OE-DATA-TABLE-COLUMN') {
        var columns = [],
          attributesToSkip = ['class', 'id'];
        for (var i = 1, l = children.length; i < l; i++) {
          if (children[i].tagName === 'OE-DATA-TABLE-COLUMN') {
            var attributes = children[i].attributes;
            var column = {};
            for (var j = 0, al = attributes.length; j < al; j++) {
              var attribute = attributes[j];
              if (attributesToSkip.indexOf(attribute.name) == -1) {
                column[kebabCaseToCamelCase(attribute.name)] = attribute.value
              }
            }
            column.disabled = children[i].hasAttribute('disabled');
            columns.push(column);
          }
        }
        this.set('columns', columns);
      }

      this.fire('oe-data-table-ready');
    },
    _getValidTemplate:function(rowChange,row,column){
      var template = this._columnTemplates.find(function(temp){
        return temp.getAttribute('column-key') === column.key;
      });
      if(template){
        this.templatize(template);
        var itemNode = this.stamp({
          row:row,
          column:column
        });
        return itemNode
      }
    },
    attached: function () {
      this.maxRowHeight = 48;
      this.async(function () {
        var form = this.$['form-component'];
        form.addEventListener('oe-action-add', this._formHandleAdd.bind(this));
        form.addEventListener('oe-action-update', this._formHandleUpdate.bind(this));

        form.addEventListener('oe-formdata-inserted', this._formHandleRemoteAdd.bind(this));
        form.addEventListener('oe-formdata-updated', this._formHandleRemoteUpdate.bind(this));
        form.addEventListener('oe-formdata-deleted', this._formHandleRemoteDelete.bind(this));

        //listens for click event in document.
        document.addEventListener('tap', this._resetActiveCell.bind(this));

        this.set('_hideGrid', false);
        this.set('_customizeView', false);

        this._updateRowWidth();

      });

    },

    detached: function () {
      document.removeEventListener('tap', this._resetActiveCell.bind(this));
    },

    // observer called when config object is changed
    _configChanged: function (newCfg, oldCfg) {
      if (this.config) {
        if (!this.editorFormUrl || (oldCfg && this.editorFormUrl === oldCfg.editorFormUrl)) {
          this.set('editorFormUrl', this.config.editorFormUrl);
        }
        if (!this.label || (oldCfg && this.label === oldCfg.label)) {
          this.set('label', this.config.label);
        }
        if (!this.columns || this.columns.length === 0 || (oldCfg && this.columns === oldCfg.columns)) {
          this.set('columns', this.config.columns);
        }
      }
    },

    // observer called when configCode is changed
    _configCodeChanged: function () {
      if (this.configCode) {
        // adding a minimal delay letting table to attach in DOM.
        this.async(function () {

          var ajaxRequest = document.createElement('oe-ajax');
          ajaxRequest.contentType = 'application/json';
          ajaxRequest.handleAs = 'json';
          ajaxRequest.url = this._getRestApiRoot() + '/GridConfigs/config/' + this.configCode;

          ajaxRequest.addEventListener('response', function (event) {
            var config = event.detail.response
            this._saveGridConfigInLocalStroage(this.configCode, config);
            this.set('config', config);
          }.bind(this));

          ajaxRequest.addEventListener('error', function (err) {
            var gridConfig = this._getGridConfigFromLocalStroage(this.configCode);
            if (gridConfig) {
              this.set('config', gridConfig);
              return;
            }
            this.fire('oe-show-error', OEUtils.extractErrorMessage(err));
          }.bind(this));

          ajaxRequest.generateRequest();
        }, 300);
      }
    },

    _toggleSelectAll: function (evt) {
      var items = this.dataController ? this._items : this.items;
      if (evt.currentTarget.checked) {
        items.forEach(function (item) {
          this.selectItem(item);
        }.bind(this));
      } else {
        this.selectedItems.forEach(function (item) {
          this.deselectItem(item);
        }.bind(this));
      }
    },

    _toggleSelection: function (event) {
      this.toggleSelection(event.model.row);
    },

    _getSelectionState: function (item) {
      return this._selectionState.get(item) ? true : false;
    },

    _computeCellWidth: function (width) {
      return width ? '0 0 ' + width + 'px' : '1';
    },

    _computeCellMinWidth: function (minWidth) {
      var minWidthToSet = minWidth || this.minColWidth;
      return minWidthToSet ? minWidthToSet + 'px' : 'initial';
    },

    _computeClassforRow: function (item, _computeSelection) { // eslint-disable-line no-unused-vars
      return this._selectionState.get(item) ? 'selected' : '';
    },

    _changeColumnWidth: function (event) {
      var index = this.columns.indexOf(event.detail.column)
      this.set('columns.' + index + '.width', event.detail.width);
      this._updateRowWidth();
    },

    _updateRowWidth: function () {
      var rowList = this.$$('#row-list');
      this.async(function () {
        if (rowList) {
          this.set('_scrollBarWidth', rowList.offsetWidth - rowList.clientWidth);
          this.customStyle['--row-width'] = this.$['table-header'].scrollWidth + 'px';
          this.updateStyles();
        }
      }, 100);
    },

    _scrollHandler: function (event) {
      var rowList = event.target;
      var summaryRow = this.$$('#summary-row-content');
      this.$['table-header'].scrollLeft = rowList.scrollLeft;
      if (summaryRow) {
        summaryRow.scrollLeft = rowList.scrollLeft;
      }
    },

    _disablePrevious: function (currentPage) {
      return currentPage && currentPage == 1;
    },

    _disableNext: function (isLastPage) {
      return isLastPage;
    },
    _computeReadOnly: function(disableEdit,disabled){
      return (disableEdit||disabled) ;
    },
    _computeGridHeight: function (pageSize, itemsToShow) {
      this.async(function () {
        this.updateRowHeight();
        this.maxRowHeight = 48;
      }, 0);
      var size = ((itemsToShow > 5 && itemsToShow < pageSize) ? itemsToShow : pageSize)
      this.set('_maxDomElement',size*2);
      return size * 48;
    },

    _rowActionClicked: function (event) {
      event.stopPropagation();
      var model = event.model;
      this.fire('oe-data-table-row-action', {
        action: model.action,
        row: model.row
      });
      var actionObj = model.action;
      if (actionObj.action) {
        var eventName = 'oe-data-table-row-action-' + actionObj.action;
        this.fire(eventName, {
          action: actionObj,
          row: model.row
        });
      }
    },

    _computeRowActionWidth: function (rowActions) {
      return '0 0 ' + (rowActions * 48) + 'px';
    },

    _showAddForm: function (event) { // eslint-disable-line no-unused-vars
      var form = this.$['form-component'];
      
      function addNewRecord(ev){
        ev && ev.stopPropagation();
        form.newRecord(this.defaultRecord);
        if (this.recordHandling !== 'remote') {
          form.set('emitOnSave', 'oe-action-add');
        } else {
          form.set('emitOnSave', '');
        }
        this.set('_hideGrid', true);
        form.removeEventListener('lazy-component-loaded',addNewRecord);
      }

      if(this.dataTableFormUrl !== this.editorFormUrl){
        form.addEventListener('lazy-component-loaded',addNewRecord.bind(this));
        this.set('dataTableFormUrl',this.editorFormUrl);
      }else{
        addNewRecord.call(this);
      }
    },

    _showEditForm: function (event) { // eslint-disable-line no-unused-vars
      var form = this.$['form-component'];

      function editRecord(ev){
        ev && ev.stopPropagation();
        form.set('model', JSON.parse(JSON.stringify(this.selectedItems[0])));
        if (this.recordHandling !== 'remote') {
          form.set('emitOnSave', 'oe-action-update');
        } else {
          form.set('emitOnSave', '');
        }
        this.set('_hideGrid', true);
        this.set('_modelBeingUpdated', this.selectedItems[0]);
        form.removeEventListener('lazy-component-loaded',editRecord);
      }

      if (this.selectedItems.length) {
        if(this.dataTableFormUrl !== this.editorFormUrl){
          form.addEventListener('lazy-component-loaded',editRecord.bind(this));
          this.set('dataTableFormUrl',this.editorFormUrl);
        }else{
          editRecord.call(this);
        }
      }
    },

    _goBack: function (event) { // eslint-disable-line no-unused-vars
      this.set('_hideGrid', false);
    },

    _formHandleAdd: function (event) {
      event.stopPropagation();
      var items = this.dataController ? '_items' : 'items';
      var newRecord = event.detail;
      if (this.recordHandling === 'localex') {
        newRecord.__row_status = 'added';
      }
      if (!this[items]) {
        this.set(items, []);
      }
      this.async(function () {
        this.push(items, newRecord);
      }, 300);
      this._goBack();
    },

    _formHandleUpdate: function (event) {
      event.stopPropagation();
      var items = this.dataController ? '_items' : 'items';
      if (this._modelBeingUpdated) {
        var index = this[items].indexOf(this._modelBeingUpdated);
        this.deselectItem(this._modelBeingUpdated);
        var newRecord = event.detail;
        if (this.recordHandling === 'localex') {
          newRecord.__row_status = newRecord.__row_status || 'modified';
        }
        (index >= 0) && this.splice(items, index, 1, newRecord);
        this.set('_modelBeingUpdated', null);
      }
      this._goBack();
    },

    _formHandleRemoteAdd: function (event) {
      var items = this.dataController ? '_items' : 'items';
      if (!this[items]) {
        this.set(items, []);
      }
      this.push(items, event.detail.data);
      if (this.dataController) {
        this._organizeData();
      }
      this._goBack();
    },

    _formHandleRemoteUpdate: function (event) {
      var items = this.dataController ? '_items' : 'items';
      if (this._modelBeingUpdated) {
        var index = this[items].indexOf(this._modelBeingUpdated);
        this.deselectItem(this._modelBeingUpdated);
        var newRecord = event.detail.data;
        (index >= 0) && this.splice(items, index, 1, newRecord);
        this.set('_modelBeingUpdated', null);
      }
      if (this.dataController) {
        this._organizeData();
      }
      this._goBack();
    },

    _formHandleRemoteDelete: function (event) {
      var items = this.dataController ? '_items' : 'items';
      var model = event.detail.data;
      this.splice(items, this[items].indexOf(model), 1);
      if (this.dataController) {
        this.cancelAsync(this._organizeDataTaskOnDelete);
        this._organizeDataTaskOnDelete = this.async(function () {
          this._organizeData();
        }, 300);
      }
    },

    _deleteSelectedRows: function (event) {
      var items = this.dataController ? this._items : this.items;
      var indexesToDelete = this.selectedItems.map(function (item) {
        return items.indexOf(item);
      }.bind(this)).sort(function (a, b) {
        return b - a;
      });

      if (indexesToDelete.length) {

        var form = this.$['form-component'];

        indexesToDelete.forEach(function (index) {
          var deletedRecord = items[index];
          this.deselectItem(deletedRecord);
          if (this.recordHandling === 'localex' && deletedRecord.id) {
            this.set('items.' + index + '.__row_status', 'deleted');
          } else if (this.recordHandling === 'remote') {
            this.set('modelToEdit', deletedRecord);
            form.element && form.element.doDelete(event);
          } else {
            // assume local for now
            this.splice(this.dataController ? '_items' : 'items', index, 1);
          }
        }.bind(this));
      }
    },

    _computeCellClass: function (rowChange, column) {
      var classesToApply = [],
        row = rowChange.base,
        value = row[column.key]; // eslint-disable-line no-unused-vars
      if (column.cellClass) {
        classesToApply.push(column.cellClass);
      }
      if (column.cellClassRules) {
        Object.keys(column.cellClassRules).forEach(function (className) {
          if (eval(column.cellClassRules[className])) {
            classesToApply.push(className);
          }
        });
      }
      return classesToApply.join(' ');
    },

    _rowClicked: function (event) {
      // event.model.row will contain the object
      this.fire('oe-data-table-row-clicked', event);
      this.toggleSelection(event.model.row);
    },

    //sets the active cell that is being edited
    _setActiveCell: function (event) {

      this._resetActiveCell();
      var elementToSet = event.detail.element;
      if (elementToSet && !this.disableEdit) {
        elementToSet.enterEditMode();
      }
      this.set('_activeCell', elementToSet);
    },

    // removes the active cell if exists
    _resetActiveCell: function (event) { // eslint-disable-line no-unused-vars
      var activeCell = this._activeCell;
      if (activeCell) {
        activeCell.exitEditMode();
        this.set('_activeCell', null);
      }
    },

    // navigates to another cell if tab is pressed
    _goToCell: function (event) {
      if (event.which == 9) {
        var cellElement = null;
        if (event.shiftKey) {
          var currentRow = event.target.parentElement;
          var previousRow = currentRow.previousElementSibling;
          if (previousRow.className.indexOf('table-row') != -1) {
            var cells = previousRow.querySelectorAll('oe-data-table-cell');
            cellElement = cells[cells.length - 1];
          }
        } else {
          cellElement = event.target.nextElementSibling.nextElementSibling;
        }

        if (cellElement) {
          event.preventDefault();
          this.fire('set-active-cell', {
            element: cellElement
          });
        }
      }
    },

    _totalRowsCount: function (totalRowsLength) {
      return totalRowsLength == Infinity ? 'More' : totalRowsLength;
    },

    _getFirstLetter: function (row, prop) {
      var value = row[prop];
      return typeof value == 'string' ? value.charAt(0).toUpperCase() : null;
    },

    _computeSelectionCellContentStyle: function (row, selectionCellContent) {
      var colors = ['#f55a6d', '#f5a623', '#009688', '#8b572a'];
      var URL = row[selectionCellContent.image];
      var style = '';
      if (URL) {
        style = 'background-image: url("' + URL + '")';
      } else {
        var firstChar = row[selectionCellContent.content].toUpperCase();
        style = 'background:' + colors[firstChar.charCodeAt(0) % colors.length];
      }
      return style;
    },

    _enableSelectionCellContent: function (row, selectionCellContent) {
      var imageExists = selectionCellContent.image && row[selectionCellContent.image];
      return selectionCellContent.content && !imageExists;
    },

    _checkboxTapped: function (event) {
      event.stopPropagation();
    },

    _openColumnChooser: function (event) { // eslint-disable-line no-unused-vars
      this.$['column-chooser'].open();
    },

    _openColumnCustomizer: function (event) { // eslint-disable-line no-unused-vars
      this.set('_customizeView', true);
    },

    _hideColumnCustomizer: function (event) { // eslint-disable-line no-unused-vars
      this.set('_customizeView', false);
    },

    showGrid: function (_hideGrid, _customizeView) {
      if (_hideGrid || _customizeView) return false;
      else return true;
    },

    customizeView: function (event) {
      this.set('columns', event.detail);
      this.set('_customizeView', false);
    },

    _getVisibleColumns: function (column) {
      return !(column.hidden === true || column.hidden === 'true');
    },

    _tableActionTapped: function (event) {
      var actionObj = event.model.action;
      var eventName = 'oe-data-table-action-' + actionObj.action;
      this.fire(eventName, {
        action: actionObj
      });
    },

    _saveGridConfigInLocalStroage: function (configCode, gridConfig) {
      var savedGridConfigs = localStorage.gridConfigs;
      if (savedGridConfigs) {
        savedGridConfigs = JSON.parse(savedGridConfigs);
      } else {
        savedGridConfigs = {};
      }
      savedGridConfigs[configCode] = gridConfig;
      localStorage.gridConfigs = JSON.stringify(savedGridConfigs);
    },

    _getGridConfigFromLocalStroage: function (configCode) {
      var savedGridConfigs = localStorage.gridConfigs;
      if (savedGridConfigs) {
        savedGridConfigs = JSON.parse(savedGridConfigs);
        return savedGridConfigs[configCode];
      }
      return undefined;
    },

    // saves or updates grid config
    _saveGridConfig: function (event) { // eslint-disable-line no-unused-vars
      if (this.configCode) {

        var config = this.config || {};
        config.code = this.configCode;
        config.columns = this.columns;

        this._saveGridConfigInLocalStroage(this.configCode, config);

        var ajaxRequest = document.createElement('oe-ajax');
        ajaxRequest.contentType = 'application/json';
        ajaxRequest.handleAs = 'json';
        ajaxRequest.url = this._getRestApiRoot() + '/GridConfigs';
        ajaxRequest.method = config.id ? 'PUT' : 'POST';
        ajaxRequest.body = JSON.stringify(config);

        ajaxRequest.addEventListener('response', function (event) {
          var response = event.detail.response;
          this.set('config', response);
          this.fire('oe-show-success', 'Grid config saved successfully');
        }.bind(this));

        ajaxRequest.addEventListener('error', function (err) {
          this.fire('oe-show-error', OEUtils.extractErrorMessage(err));
        }.bind(this));

        ajaxRequest.generateRequest();
      }
    },

    _computeSummary: function (column, _itemsChange) { // eslint-disable-line no-unused-vars
      var aggregator = column.aggregator;
      var result;
      if (aggregator && this._items && this._items.length > 0) {
        var key = column.key || column.field;
        switch (aggregator) {
          case 'sum':
            result = this._items.reduce(function (a, b) {
              var param = Number(b[key]);
              return a + (isNaN(param) ? 0 : param);
            }, 0);
            break;
          case 'average':
            result = this._items.reduce(function (a, b) {
              var param = Number(b[key]);
              return a + (isNaN(param) ? 0 : param);
            }, 0) / this._items.length;
            break;
          case 'count':
            return this._items.length;
          default:
            if (typeof aggregator === 'function') {
              result = aggregator.call(this, this._items);
            } else if (typeof aggregator === 'string') {
              if (aggregator.trim().indexOf('function') === 0) {
                var aggregatorFunction = new Function('return ' + aggregator)();
                result = aggregatorFunction.call(this, this._items);
              } else {
                console.warn(
                  'The column aggregator should be a string or a function or a function as a string'
                );
              }
            } else {
              console.warn('The column aggregator should be a string or a function');
            }
            break;
        }

        if (result) {
          var options = column.editorAttributes;
          if (column.formatter) {
            return column.formatter.call(this, result, options);
          } else if (column.type && OEUtils.TypeMappings[column.type] && OEUtils.TypeMappings[column.type].formatter) {
            var formatterFn = OEUtils.TypeMappings[column.type].formatter;
            return formatterFn(result, options);
          } else {
            return result;
          }
        }
      }

      return null;
    },

    _hasAggregator: function (columns) { // eslint-disable-line no-unused-vars
      return this.columns && this.columns.length > 0 && this.columns.some(function (column) {
        return column.aggregator !== undefined;
      });
    },

    _computeTableBodyClass: function (aggregatorAlignTop) {
      return aggregatorAlignTop ? 'reverse' : '';
    },

    _computeCellAlignment: function (column) {
      return ['number', 'decimal'].indexOf(column.type || column.uitype) > -1 ? 'text-align: right' :
        null;
    },

    _showMenuIcon: function (configCode, menuActions) {
      return configCode || (menuActions && menuActions.length > 0);
    },

    _hideEditIcon: function (selectedItemsLength) {
      return selectedItemsLength !== 1;
    },

    _getRestApiRoot: function(){
      var restApiRoot = (window.OEUtils && window.OEUtils.restApiRoot) ? window.OEUtils.restApiRoot : '/api';
      return restApiRoot;
    },

    _isMultiSelected:function(selectedItemsLength){
      return selectedItemsLength > 1;
    }
  });

</script>
